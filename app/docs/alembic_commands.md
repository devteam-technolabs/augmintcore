# Alembic Migration Commands Cheat Sheet (FastAPI + SQLAlchemy)

## 1. Initialize Alembic
If Alembic is not yet initialized:

```bash
alembic init alembic
```

This creates:

- `alembic/` directory  
- `alembic.ini`  
- `env.py`, `versions/`, etc.

---

## 2. Creating Migrations

### Autogenerated Migration
Detects changes from SQLAlchemy models:

```bash
alembic revision --autogenerate -m "message"
```

Example:

```bash
alembic revision --autogenerate -m "create users table"
```

---

### Manual Migration (Empty Revision File)

```bash
alembic revision -m "manual change"
```

---

## 3. Applying Migrations

### Upgrade to Latest Revision

```bash
alembic upgrade head
```

---

### Upgrade Step-by-Step

```bash
alembic upgrade +1
```

---

### Upgrade to Specific Revision

```bash
alembic upgrade <revision_id>
```

---

## 4. Downgrading Migrations

### Downgrade One Step

```bash
alembic downgrade -1
```

---

### Downgrade to Base (Empty DB)

```bash
alembic downgrade base
```

---

### Downgrade to Specific Revision

```bash
alembic downgrade <revision_id>
```

---

## 5. Migration History & Status

### Show Current Revision

```bash
alembic current
```

---

### Full History

```bash
alembic history
```

---

### Verbose History

```bash
alembic history --verbose
```

---

## 6. Stamping the Database

### Stamp as Latest Without Running Migrations

```bash
alembic stamp head
```

---

### Stamp to Specific Revision

```bash
alembic stamp <revision_id>
```

---

## 7. Edit an Existing Revision

Opens revision in your default editor:

```bash
alembic edit <revision_id>
```

---

## 8. Multiple Heads & Merging

### Show All Heads

```bash
alembic heads
```

---

### Merge Multiple Branches

```bash
alembic merge -m "merge heads" <head1> <head2>
```

---

## 9. FastAPI Auto-Generate Setup

Make sure your `alembic/env.py` includes:

```python
from app.db import Base  # adjust import path
target_metadata = Base.metadata
```

If autogenerate does not detect changes, itâ€™s usually because of incorrect `target_metadata`.

---

## 10. Typical FastAPI Migration Workflow

1. Modify SQLAlchemy models  
2. Generate migration:

```bash
alembic revision --autogenerate -m "updated models"
```

3. Apply migration:

```bash
alembic upgrade head
```

4. Verify:

```bash
alembic current
```

---

## 11. Useful Extra Commands

### Re-run Latest Migration (Downgrade + Upgrade)

```bash
alembic downgrade -1 && alembic upgrade head
```

---

### Create Migration Targeting Specific Head

```bash
alembic revision --head=heads --autogenerate -m "fix"
```

---

## 12. Summary Table (Cheat Sheet)

| Purpose | Command |
|--------|---------|
| Initialize Alembic | `alembic init alembic` |
| Create migration | `alembic revision -m "msg"` |
| Autogenerate migration | `alembic revision --autogenerate -m "msg"` |
| Apply latest | `alembic upgrade head` |
| Upgrade step | `alembic upgrade +1` |
| Downgrade step | `alembic downgrade -1` |
| Downgrade to base | `alembic downgrade base` |
| Show current revision | `alembic current` |
| Show history | `alembic history` |
| Stamp DB | `alembic stamp head` |
| Merge revision branches | `alembic merge <rev1> <rev2>` |
| Edit a revision | `alembic edit <revision_id>` |
